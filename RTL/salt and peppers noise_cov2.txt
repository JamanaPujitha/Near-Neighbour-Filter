module conv(
input        i_clk,
input [71:0] i_pixel_data,
input        i_pixel_data_valid,
output reg [7:0] o_convolved_data,
output reg   o_convolved_data_valid
    );
    
integer i; 
integer count;
reg [7:0] kernel [8:0];
reg [7:0] multData[8:0];
reg [15:0] sumDataInt;
reg [7:0] center_pixel;
reg multDataValid;

initial
 begin
    for (i = 0; i < 9; i = i + 1)
     begin
        kernel[i] = 1;
    end
end    
    
always @(posedge i_clk)
 begin
    if (i_pixel_data_valid)
     begin
        for (i = 0; i < 9; i = i + 1) 
        begin
            multData[i] <= i_pixel_data[i*8 +: 8];
        end
        center_pixel <= i_pixel_data[4*8 +: 8]; 
        multDataValid <= 1;
    end 
    else
     begin
        multDataValid <= 0;
    end
end

always @(posedge i_clk)
 begin
    if (multDataValid)
     begin
        sumDataInt <= 0;
        count <= 0;
   
        for (i = 0; i < 9; i = i + 1)
         begin
            if (multData[i] != 0 && multData[i] != 255)
             begin
                sumDataInt = sumDataInt + multData[i];
                count = count + 1;
            end
        end
    end
end

always @(posedge i_clk)
 begin
    if (multDataValid) 
    begin

        if (center_pixel == 0 || center_pixel == 255) begin
            if (count > 0)
             begin
                o_convolved_data <= sumDataInt / count; 
            end 
            else 
            begin
                o_convolved_data <= center_pixel; 
            end
        end
         else 
         begin
            o_convolved_data <= center_pixel; 
        end
        o_convolved_data_valid <= 1;
    end 
    else
     begin
     o_convolved_data_valid <= 0;
    end
end
endmodule